#
# Vagrantfile
#
#
# Copyright 2020, Steve Kukla, All Rights Reserved.
require "json"

# Clear the screen
system ("clear")

top_dir = "#{File.expand_path("..", Dir.pwd)}"
data_pack_dir = "#{top_dir}/demo"
app_dir = File.dirname(File.expand_path(__FILE__))
demo_builder_files_path = "#{app_dir}/cookbooks/magento_demo_builder/files/demo"
app_structure = ["data", "media", "patches"]
environment_file = "#{app_dir}/environments/vm.rb"
config_file = "#{data_pack_dir}/config.json"

# Read the configuration json file
config_file_content = File.read(config_file)
settings = JSON.parse(config_file_content)

# Start VM Setup
Vagrant.configure("2") do |config|
  
  # Plugin check (VMWare Fusion and Virtualbox will want different Vagrant plugins)
  config.trigger.before :up do |trigger|
    trigger.name = "Checking for required plugins..."
    trigger.ruby do
      plugins = settings["vagrant"]["plugins"]["all"]
      if settings["vm"]["provider"] == "virtualbox"
        plugins.push(*settings["vagrant"]["plugins"]["virtualbox"])
      else
        plugins.push(*settings["vagrant"]["plugins"]["vmware"])
      end
      plugins.each do |plugin|
        unless Vagrant.has_plugin?("#{plugin}")
          system("vagrant plugin install #{plugin}", :chdir=>"/tmp") || exit!
        end
      end
      sleep(1)
    end
  end

  
  app_structure.each do |media_type|
    if Dir.exist?("#{data_pack_dir}/#{media_type}")
      config.trigger.before [:up, :reload, :provision] do |trigger|
        trigger.name = "Preparing #{media_type}..."
        trigger.ruby do
          if Dir.exist?("#{demo_builder_files_path}/#{media_type}") && !Dir.empty?("#{demo_builder_files_path}/#{media_type}")
            FileUtils.remove_entry("#{demo_builder_files_path}/#{media_type}")
          end
          FileUtils.copy_entry("#{data_pack_dir}/#{media_type}", "#{demo_builder_files_path}/#{media_type}")
        end
      end
    end
  end

  # Write out chef environment file from configuration
  config.trigger.before [:up, :reload, :provision] do |trigger|
    trigger.name = "Creating environment file..."
    trigger.ruby do
      environment_file_content = [
          'name "vm"',
          'description "Configuration file for the Kukla Demo VM"',
          "default_attributes(#{settings})"
      ]  
      File.open(environment_file, "w+") do |file|
          file.puts(environment_file_content)
      end
      sleep(1)
    end
  end
  
  # SSH/Password access and VM Box
  config.ssh.insert_key = false
  config.ssh.forward_agent = true
  
  config.vm.box = settings["remote_machine"]["box"]

  # Set the hostname and configure networking
  config.vm.define settings["remote_machine"]["name"] do |machine|
    machine.vm.network "private_network", ip: settings["vm"]["ip"]
    
    # Get urls for custom demo and create hostname and aliases
    demo_urls = Array.new
    settings["custom_demo"]["structure"].each do |scope, scope_hash|
      scope_hash.each do |code, url|
        if code == "base"
          machine.vm.hostname = settings["custom_demo"]["structure"]["website"]["base"]
        else
          demo_urls << url
        end
      end
    end
    config.multihostsupdater.aliases = demo_urls
  end

  # Configure VM machine based on provider
  config.vm.provider "#{settings["vm"]["provider"]}" do |machine|
    if settings["vm"]["provider"] == "virtualbox"
      machine.gui = settings["remote_machine"]["provider"]["virtualbox"]["gui"]
      machine.linked_clone = settings["remote_machine"]["provider"]["virtualbox"]["linked_clones"]
      machine.default_nic_type = settings["remote_machine"]["provider"]["virtualbox"]["default_nic_type"]
      machine.customize [
        "modifyvm", :id,
          "--name", settings["vm"]["name"],
          "--memory", settings["remote_machine"]["ram"],
          "--cpus", settings["remote_machine"]["cpus"],
          "--vram", settings["remote_machine"]["vram"],
          "--vrde", settings["remote_machine"]["provider"]["virtualbox"]["remote_display"]
          
      ]
    # VMWare-specific settings
    elsif settings["vm"]["provider"].include?("vmware")
      machine.gui = settings["remote_machine"]["provider"]["vmware"]["gui"]
      machine.linked_clone = settings["remote_machine"]["provider"]["vmware"]["linked_clones"]
      machine.vmx["memsize"] = settings["remote_machine"]["ram"]
      machine.vmx["numvcpus"] = settings["remote_machine"]["cpus"]
      machine.vmx["ethernet0.pcislotnumber"] = settings["remote_machine"]["provider"]["vmware"]["eth0_pcislotnumber"]
      machine.vmx["ethernet1.pcislotnumber"] = settings["remote_machine"]["provider"]["vmware"]["eth1_pcislotnumber"]
    end
  end

  # Run Chef check provisioner
  config.vm.provision "#{settings["provisioner"]["type"]}" do |chef|
    chef.version = "#{settings["provisioner"]["version"].chomp}"
    chef.nodes_path = "#{settings["provisioner"]["nodes_path"]}"
    chef.environments_path = "#{settings["provisioner"]["environments_path"]}"
    chef.roles_path = "#{settings["provisioner"]["roles_path"]}"
    chef.cookbooks_path = "#{settings["provisioner"]["cookbooks_path"]}"

    # Environment
    chef.environment = "vm"

    # Roles
    chef.add_role "base"
    chef.add_role "infrastructure"
    chef.add_role "application"

    # Accept Chef License
    chef.arguments = "--chef-license accept"
  end
end